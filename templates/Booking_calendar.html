<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Calendar</title>
    <link rel="stylesheet" href="/static/Calendar.css">
    <link rel="stylesheet" href="/static/Slots.css">
</head>
<body>
    <div class="calendar">
        <div class="calendar-header">
            <button id="prev-month">&lt;</button>
            <span id="month-year">December 2024</span>
            <button id="next-month">&gt;</button>
        </div>
        <div class="calendar-days">
            <div class="day-label">Sun</div>
            <div class="day-label">Mon</div>
            <div class="day-label">Tue</div>
            <div class="day-label">Wed</div>
            <div class="day-label">Thu</div>
            <div class="day-label">Fri</div>
            <div class="day-label">Sat</div>
        </div>
    </div>

    <div id="slots-container" style="display: none;">
        <h3>Available Slots</h3>
        <div id="slots"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calendarDays = document.querySelector('.calendar-days');
            const monthYear = document.getElementById('month-year');
            const prevMonth = document.getElementById('prev-month');
            const nextMonth = document.getElementById('next-month');

            const slotsContainer = document.getElementById('slots-container');
            const slotsDiv = document.getElementById('slots');

            let currentDate = new Date();

            function generateCalendar(date) {
                calendarDays.innerHTML = '';

                const year = date.getFullYear();
                const month = date.getMonth();

                monthYear.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = 0; i < firstDay; i++) {
                    const emptySlot = document.createElement('div');
                    emptySlot.className = 'day disabled';
                    calendarDays.appendChild(emptySlot);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'day';
                    dayElement.textContent = day;

                    const dayDate = new Date(year, month, day);
                    dayDate.setHours(0, 0, 0, 0);

                    if (dayDate < today) {
                        dayElement.classList.add('disabled');
                    } else {
                        dayElement.addEventListener('click', () => fetchSlots(dayDate));
                    }

                    calendarDays.appendChild(dayElement);
                }
            }

            async function fetchSlots(date) {
                try {
                    const response = await fetch(`/api/slots?date=${date.toISOString()}`);
                    const slots = await response.json();

                    displaySlots(slots);
                } catch (error) {
                    console.error('Error fetching slots:', error);
                    alert('Failed to load slots. Please try again later.');
                }
            }

            function displaySlots(slots) {
                slotsContainer.style.display = 'block';
                slotsDiv.innerHTML = '';

                slots.forEach(slot => {
                    const slotElement = document.createElement('div');
                    slotElement.className = 'slot';
                    slotElement.textContent = slot.time;

                    if (slot.booked) {
                        slotElement.classList.add('booked');
                        slotElement.style.pointerEvents = 'none';
                    }

                    slotsDiv.appendChild(slotElement);
                });
            }

            prevMonth.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                generateCalendar(currentDate);
            });

            nextMonth.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                generateCalendar(currentDate);
            });

            generateCalendar(currentDate);
        });
    </script>
</body>
</html>